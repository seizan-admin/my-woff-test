<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WOFF getAccessToken Test</title>
  <script src="https://static.worksmobile.net/static/wm/woff/edge/3.6/sdk.js"></script>
</head>
<body>

<div id="valid" style="display:none;">
  <h1 style="color: blue;">WOFF getAccessToken テスト</h1>

  <p id="status">処理中...</p>

  <!-- 未ログイン時のみ表示 -->
  <button id="login-btn" style="display:none;">ログインする</button>

  <h2>Profile</h2>
  <pre id="profile" style="background:#f4f4f4; padding:10px;"></pre>

  <h2>Access Token（⚠テスト用）</h2>
  <pre id="token" style="background:#ffecec; padding:10px; word-break: break-all;"></pre>
</div>

<div id="invalid" style="display:none; color:red;">
  <h1>エラー</h1>
  <p id="error-msg"></p>
</div>

<h2>Debug Info</h2>
<pre id="debug" style="white-space: pre-wrap; background:#f4f4f4; padding:10px;"></pre>

<script>
  const WOFF_ID = "r2Ff5XMgxVdYKkWtq0XgVA";

  const statusEl = document.getElementById("status");
  const loginBtn = document.getElementById("login-btn");
  const profileEl = document.getElementById("profile");
  const tokenEl = document.getElementById("token");
  const debugEl = document.getElementById("debug");

  function log(msg) { debugEl.innerText += msg + "\n"; }

  function showValid(msg) {
    document.getElementById("valid").style.display = "block";
    document.getElementById("invalid").style.display = "none";
    if (msg) statusEl.innerText = msg;
  }

  function showInvalid(msg) {
    document.getElementById("valid").style.display = "none";
    document.getElementById("invalid").style.display = "block";
    document.getElementById("error-msg").innerText = msg || "";
  }

  // 戻り先URL（URL揺れ防止）
  const REDIRECT_URI = location.origin + location.pathname;

  // Debug
  log("href        : " + location.href);
  log("redirectUri : " + REDIRECT_URI);
  log("userAgent   : " + navigator.userAgent);
  log("");

  function doLogin() {
    log("calling woff.login()");
    showValid("ログイン画面へ遷移します...");
    woff.login({ redirectUri: REDIRECT_URI });
  }
  loginBtn.addEventListener("click", doLogin);

  // ===== WOFF フロー =====
  woff.init({ woffId: WOFF_ID })
    .then(async () => {
      log("woff.init(): SUCCESS");
      showValid("初期化OK。ログイン状態を確認中...");

      // ログイン判定
      if (typeof woff.isLoggedIn === "function") {
        const loggedIn = woff.isLoggedIn();
        log("woff.isLoggedIn(): " + loggedIn);

        if (!loggedIn) {
          loginBtn.style.display = "inline-block";
          showValid("未ログインです。「ログインする」を押してください。");
          return;
        }
      }

      // プロフィール取得
      showValid("ログイン済み。プロフィール取得中...");
      const profile = await woff.getProfile();
      profileEl.innerText = JSON.stringify(profile, null, 2);

      // ★ Access Token 取得（テスト用）
      showValid("アクセストークン取得中...");
      const token = await woff.getAccessToken();

      tokenEl.innerText = token;
      log("getAccessToken(): SUCCESS");
      log("token length: " + token.length);

      showValid("完了（テスト用にアクセストークンを表示しています）");
    })
    .catch(err => {
      log("WOFF ERROR: " + String(err));
      showInvalid("WOFF エラー: " + err);
    });
</script>

</body>
</html>
