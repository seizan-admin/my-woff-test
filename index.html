<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WOFF Redirect / Init Test</title>
  <script src="https://static.worksmobile.net/static/wm/woff/edge/3.6/sdk.js"></script>
</head>
<body>

<div id="valid" style="display:none;">
  <h1 style="color: blue;">WOFFテスト成功！</h1>
  <p id="user-info">処理中...</p>
</div>

<div id="invalid" style="display:none; color:red;">
  <h1>無効なアクセス</h1>
  <p>このページは LINE WORKS の WOFF からのみ利用できます。</p>
  <p id="error-msg"></p>
</div>

<h2>Debug Info</h2>
<pre id="debug" style="white-space: pre-wrap; background:#f4f4f4; padding:10px;"></pre>

<script>
  const MY_WOFF_ID = "r2Ff5XMgxVdYKkWtq0XgVA";

  const debug = document.getElementById("debug");
  const userInfo = document.getElementById("user-info");

  function logDebug(msg) { debug.innerText += msg + "\n"; }

  function showValid(msg) {
    document.getElementById("valid").style.display = "block";
    document.getElementById("invalid").style.display = "none";
    if (msg) userInfo.innerText = msg;
  }

  function showInvalid(msg) {
    document.getElementById("valid").style.display = "none";
    document.getElementById("invalid").style.display = "block";
    document.getElementById("error-msg").innerText = msg || "";
  }

  // --- Debug info ---
  logDebug("=== Location Info ===");
  logDebug("href   : " + location.href);
  logDebug("origin : " + location.origin);
  logDebug("path   : " + location.pathname);
  logDebug("search : " + location.search);
  logDebug("hash   : " + location.hash);
  logDebug("");
  logDebug("=== User Agent ===");
  logDebug(navigator.userAgent);
  logDebug("");
  logDebug("=== woff object ===");
  logDebug(String(window.woff));
  logDebug("");

  // ★ 推奨：戻り先は “今いるページ” に統一（GitHub Pagesの末尾/違い事故を避ける）
  const REDIRECT_URI = location.origin + location.pathname;

  // --- WOFF flow ---
  woff.init({ woffId: MY_WOFF_ID })
    .then(() => {
      logDebug("woff.init(): SUCCESS");
      showValid("初期化OK。ログイン状態を確認中...");

      // 外部ブラウザ（Windows等）は未ログインになりがち
      if (typeof woff.isLoggedIn === "function" && !woff.isLoggedIn()) {
        logDebug("isLoggedIn(): false -> calling woff.login()");
        showValid("ログインが必要です。認証画面へ移動します...");

        // ここでリダイレクト（再読み込み）されるのが通常
        woff.login({ redirectUri: REDIRECT_URI });
        return null; // 以降の処理は再読み込み後に実行される想定
      }

      logDebug("isLoggedIn(): true (or not available) -> calling getProfile()");
      return woff.getProfile();
    })
    .then(profile => {
      if (!profile) return; // login()で飛んだ場合など
      logDebug("woff.getProfile(): SUCCESS");
      showValid(profile.displayName + "さん、こんにちは！");
    })
    .catch(err => {
      logDebug("WOFF ERROR:");
      logDebug(String(err));

      // 「WOFFじゃない」場合もここに来るが、今回は token 不足が原因
      showInvalid("WOFF エラー: " + err);
    });
</script>

</body>
</html>
