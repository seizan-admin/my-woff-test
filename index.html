<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WOFF Redirect / Login Test</title>
  <script src="https://static.worksmobile.net/static/wm/woff/edge/3.6/sdk.js"></script>
</head>
<body>

<!-- ================= 有効画面 ================= -->
<div id="valid" style="display:none;">
  <h1 style="color: blue;">WOFFテスト</h1>
  <p id="user-info">処理中...</p>

  <!-- 未ログイン時にだけ表示 -->
  <button id="login-btn" style="display:none;">ログインする</button>
</div>

<!-- ================= 無効画面 ================= -->
<div id="invalid" style="display:none; color:red;">
  <h1>無効なアクセス</h1>
  <p>このページは LINE WORKS の WOFF からのみ利用できます。</p>
  <p id="error-msg"></p>
</div>

<!-- ================= デバッグ表示 ================= -->
<h2>Debug Info</h2>
<pre id="debug" style="white-space: pre-wrap; background:#f4f4f4; padding:10px;"></pre>

<script>
  // あなたの WOFF ID
  const MY_WOFF_ID = "r2Ff5XMgxVdYKkWtq0XgVA";

  const debug = document.getElementById("debug");
  const userInfo = document.getElementById("user-info");
  const loginBtn = document.getElementById("login-btn");

  function log(msg) { debug.innerText += msg + "\n"; }

  function showValid(msg) {
    document.getElementById("valid").style.display = "block";
    document.getElementById("invalid").style.display = "none";
    if (msg) userInfo.innerText = msg;
  }

  function showInvalid(msg) {
    document.getElementById("valid").style.display = "none";
    document.getElementById("invalid").style.display = "block";
    document.getElementById("error-msg").innerText = msg || "";
  }

  // 戻り先URL（GitHub Pagesの末尾スラッシュ等の揺れ防止のため「今のページ」に固定）
  const REDIRECT_URI = location.origin + location.pathname;

  // デバッグ出力
  log("=== Location Info ===");
  log("href        : " + location.href);
  log("redirectUri : " + REDIRECT_URI);
  log("origin      : " + location.origin);
  log("path        : " + location.pathname);
  log("search      : " + location.search);
  log("hash        : " + location.hash);
  log("");
  log("=== User Agent ===");
  log(navigator.userAgent);
  log("");
  log("=== woff object ===");
  log(String(window.woff));
  log("");

  // ログイン処理（ボタン押下で実行）
  function doLogin() {
    log("Calling woff.login() ...");
    showValid("ログイン画面へ遷移します...");
    // ここで認証画面へリダイレクト → 認証後にこのページへ戻る（再読み込み）
    woff.login({ redirectUri: REDIRECT_URI });
  }

  loginBtn.addEventListener("click", doLogin);

  // --- WOFFフロー本体 ---
  woff.init({ woffId: MY_WOFF_ID })
    .then(() => {
      log("woff.init(): SUCCESS");
      showValid("初期化OK。ログイン状態を確認中...");

      // isLoggedInが使える場合はログイン状態を判定
      if (typeof woff.isLoggedIn === "function") {
        const loggedIn = woff.isLoggedIn();
        log("woff.isLoggedIn(): " + loggedIn);

        if (!loggedIn) {
          // 未ログイン：ボタン表示してユーザー操作でログイン
          loginBtn.style.display = "inline-block";
          showValid("未ログインです。「ログインする」を押してください。");
          return null; // ここで止める（getProfileは呼ばない）
        }
      } else {
        // isLoggedInが無い環境は、とりあえずgetProfileを試す
        log("woff.isLoggedIn(): not available");
      }

      // ログイン済みならプロフィール取得
      log("calling woff.getProfile() ...");
      return woff.getProfile();
    })
    .then(profile => {
      if (!profile) return; // 未ログインで止めた場合など
      log("woff.getProfile(): SUCCESS");
      loginBtn.style.display = "none";
      showValid(profile.displayName + "さん、こんにちは！");
    })
    .catch(err => {
      log("WOFF ERROR:");
      log(String(err));

      // ここに来るのは init 失敗、または getProfile 失敗など
      showInvalid("WOFF エラー: " + err);
    });
</script>

</body>
</html>
