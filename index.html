<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WOFF External Browser Login Test</title>
  <script src="https://static.worksmobile.net/static/wm/woff/edge/3.6/sdk.js"></script>
</head>
<body>

<div id="ok" style="display:none;">
  <h1 style="color: blue;">WOFF OK</h1>
  <p id="msg">処理中...</p>
</div>

<div id="ng" style="display:none; color:red;">
  <h1>エラー</h1>
  <p id="err"></p>
</div>

<pre id="debug" style="white-space: pre-wrap; background:#f4f4f4; padding:10px;"></pre>

<script>
  const WOFF_ID = "r2Ff5XMgxVdYKkWtq0XgVA";
  const debug = document.getElementById("debug");
  const msg = document.getElementById("msg");

  function log(s){ debug.innerText += s + "\n"; }
  function showOK(s){ document.getElementById("ok").style.display="block"; document.getElementById("ng").style.display="none"; if(s) msg.innerText=s; }
  function showNG(e){ document.getElementById("ng").style.display="block"; document.getElementById("ok").style.display="none"; document.getElementById("err").innerText=String(e); }

  // 戻り先は「今いるページ」に固定（URL揺れ防止）
  const REDIRECT_URI = location.origin + location.pathname;

  log("href        : " + location.href);
  log("redirectUri : " + REDIRECT_URI);
  log("ua          : " + navigator.userAgent);
  log("");

  woff.init({ woffId: WOFF_ID })
    .then(async () => {
      log("woff.init(): SUCCESS");
      showOK("初期化OK。ログイン状態を確認中...");

      // 外部ブラウザでは未ログインになりがち → loginへ
      if (typeof woff.isLoggedIn === "function") {
        const loggedIn = woff.isLoggedIn();
        log("woff.isLoggedIn(): " + loggedIn);

        if (!loggedIn) {
          showOK("未ログインです。ログイン画面へ遷移します...");
          log("calling woff.login() ...");

          // ここで認証画面へリダイレクト → 認証後このページへ戻って再読み込み
          woff.login({ redirectUri: REDIRECT_URI });
          return; // ここで処理は終わる（戻ってきた後に再実行される）
        }
      } else {
        log("woff.isLoggedIn(): not available");
      }

      // ログイン済みならAPIを呼べる（access_tokenがある）
      showOK("ログイン済み。プロフィール取得中...");
      const p = await woff.getProfile();
      log("woff.getProfile(): SUCCESS");
      showOK(`${p.displayName}さん、こんにちは！`);
    })
    .catch(err => {
      log("WOFF ERROR: " + String(err));
      showNG(err);
    });
</script>

</body>
</html>
